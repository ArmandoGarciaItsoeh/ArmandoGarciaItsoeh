<html>
  <head>
    <title>Probabilidad y Estadística</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
  </head>
  <body>
    <br>
      <label for="myfile">Select a file:</label>
      <input type="file" id="myfile" name="myfile">
    <br/>
    
    <p>File Content:</p>
    <div style="border:2px inset #AAA;cursor:text;height:120px;overflow:auto;width:600px; resize:both">
      <div id="content">
      </div>
    </div>
    
    <p id="csv"></p>
    <py-config>
      packages = ["matplotlib", "pandas"]
    </py-config>

    <py-script>
      import numpy as np
      import pandas as pd
      import asyncio
      from matplotlib import pyplot as plt
      from pyodide.http import open_url
      
      from js import document, FileReader
      from pyodide import create_proxy
      
      df = pd.DataFrame(columns=['X','Y'])
      
      async def process_file(event):
        fileList = event.target.files.to_py()
        i = 0
        for f in fileList:
          data = await f.text()
          document.getElementById("content").innerHTML = data
          dat = str(data).split("\r\n")
          #print(dat)    
      
          for item in dat:
            s = item.split(',')
            if len(s) == 2:
              new_row = [ s[0], s[1] ]
              df.loc[len(df)] = new_row
                      
        #print(df)
        
        processData()
        return
        

      def main():
        # Create a Python proxy for the callback function
        # process_file() is your function to process events from FileReader
        file_event = create_proxy(process_file)

        # Set the listener to the callback
        e = document.getElementById("myfile")
        e.addEventListener("change", file_event, False)
        return
      
      def processData():
        xl = df.iloc[:,0].tolist()
        yl = df.iloc[:,1].tolist()
        
        print("Lista:")
        print(xl)
        print(yl)
      
        x = np.array(xl).astype(np.single)
        print("x Numpy array:")
        print(x)
        print(type(x))
      
        y = np.array(yl).astype(np.single)      
        print("y Numpy array:")
        print(y)
        print(type(y))
      
        xm = x.mean()
        ym = y.mean()
        
        print("x media:")
        print(xm)
      
        print("y media:")
        print(ym)
        m = sum( (x - xm) * (y - ym) ) / sum((x - xm)**2)
        b = ym - m*xm
        
        print("m:")
        print(str(m))
        
        print("b:")
        print(str(b))
                
        xlinea = np.linspace(x.min(), x.max(), 30)
        ylinea = m*xlinea + b
        ley = "y = " + str(m) + " + " + str(b)
        print(ley)
        plt.figure(figsize=(10,10))
        plt.title(label="Regresión Lineal. García Bautista Jorge Armando", fontsize=20 )
        plt.scatter(x,y, label = "Datos")
        plt.plot(xlinea, ylinea, label = ley, color = 'salmon')
        plt.legend()
        plt.xlabel("X")
        plt.ylabel("Y")
        display(plt, target="graph-area", append=True)
        return
      
      main()
      
      
    </py-script>

    <py-repl>
      ok10
    </py-repl>

    <div id="graph-area"></div>
  </body>
</html>
